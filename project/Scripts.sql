/*
 * Скрипты создания структуры и наполнения представлены дампом из mysql conveyor.sql
 * Ниже даны скрипты создания хранимых функций, триггеров, характерные запросы, представления.
 */
DELIMITER //

DROP FUNCTION IF EXISTS `Реальная скорость конвейера` //
CREATE FUNCTION `Реальная скорость конвейера` (id INT)
RETURNS DECIMAL(10, 3)
READS SQL DATA
BEGIN 
	DECLARE speed, gear_ratio, d DECIMAL(10,3);
	SELECT `Двигатель`.`Скорость`, `Редуктор`.`Передаточное число`, `Барабан приводной`.`Диаметр` 
		INTO speed, gear_ratio, d
		FROM 
			`Состав конвейера` 
			INNER JOIN `Приводной блок` ON `Состав конвейера`.`Приводной блок_Код` = `Приводной блок`.`Код`
			INNER JOIN `Двигатель` ON `Приводной блок`.`Двигатель_Код` = `Двигатель`.`Код`
			INNER JOIN `Редуктор` ON `Приводной блок`.`Редуктор_Код` = `Редуктор`.`Код`
			INNER JOIN `Бункер` ON `Состав конвейера`.`Бункер_Код` = `Бункер`.`Код`
			INNER JOIN `Барабан приводной` ON `Бункер`.`Барабан приводной_Код` = `Барабан приводной`.`Код`
		WHERE `Состав конвейера`.`Конвейер_Код` = id;
	RETURN speed * d * 3.14159 / gear_ratio / 60 / 1000;
END//


DROP FUNCTION IF EXISTS `Полная масса конвейера` //
CREATE FUNCTION `Полная масса конвейера` (id INT)
RETURNS DECIMAL(10, 3)
READS SQL DATA
BEGIN 
	DECLARE m INT;
	SELECT `Приводной блок`.`Масса` + `Бункер`.`Масса` + `Став линейный`.`Масса` + `Телега разгрузочная`.`Масса` + `Устройство натяжное`.`Масса` 
		INTO m
		FROM 
			`Состав конвейера` 
			INNER JOIN `Приводной блок` ON `Состав конвейера`.`Приводной блок_Код` = `Приводной блок`.`Код`
			INNER JOIN `Бункер` ON `Состав конвейера`.`Бункер_Код` = `Бункер`.`Код`
			INNER JOIN `Став линейный` ON `Состав конвейера`.`Став линейный_Код` = `Став линейный`.`Код`
			INNER JOIN `Телега разгрузочная` ON `Состав конвейера`.`Телега разгрузочная_Код` = `Телега разгрузочная`.`Код`
			INNER JOIN `Устройство натяжное` ON `Состав конвейера`.`Устройство натяжное_Код` = `Устройство натяжное`.`Код`
		WHERE `Состав конвейера`.`Конвейер_Код` = id;
	RETURN m;
END//

DROP FUNCTION IF EXISTS `Проверить скорость конвейера` //
CREATE FUNCTION `Проверить скорость конвейера` (id INT, cv0 DECIMAL(10,3))
RETURNS BOOLEAN
READS SQL DATA
BEGIN 
	DECLARE rv, cv DECIMAL(10,3);
	SELECT `Реальная скорость конвейера`(`Конвейер`.`Код`), `Конвейер`.`Скорость` INTO rv, cv FROM `Конвейер` WHERE `Конвейер`.`Код` = id;
	IF cv0 IS NOT NULL THEN
		SET cv = cv0;
	END IF;
	IF rv IS NULL OR cv IS NULL OR rv = 0 OR cv = 0 THEN
		RETURN TRUE; 
	END IF;
	RETURN ABS(rv - cv) / cv < 0.1; 
END//


DROP TRIGGER IF EXISTS `Проверка скорости_Конвейер_update` //
CREATE TRIGGER `Проверка скорости_Конвейер_update` BEFORE UPDATE ON `Конвейер` 
FOR EACH ROW
BEGIN
	IF NOT `Проверить скорость конвейера`(NEW.`Код`, NEW.`Скорость`) THEN
		SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Реальная скорость конвейера не соответствует запрошенной. Поменяйте приводной блок, редуктор или двигатель';
	END IF;
END//





DELIMITER ;

SELECT `Проверить скорость конвейера`(1, NULL);

SELECT `Полная масса конвейера`(`Конвейер`.`Код`), `Фабрика`.`Наименование`, `Конвейер`.`№ конвейера`, `Реальная скорость конвейера`(`Конвейер`.`Код`), `Конвейер`.`Скорость`, `Проверить скорость конвейера`(`Конвейер`.`Код`, NULL) 
	FROM `Конвейер` INNER JOIN `Фабрика` ON `Конвейер`.`Фабрика_Код` = `Фабрика`.`код` WHERE `Конвейер`.`Код` = 1;


SELECT `Фабрика`.`Наименование`, `Конвейер`.`№ конвейера`, `Приводной блок`.`Обозначение`, `Бункер`.`Обозначение`, `Став линейный`.`Обозначение`, `Устройство натяжное`.`Обозначение`, `Телега разгрузочная`.`Обозначение`
	FROM `Фабрика`
	INNER JOIN `Конвейер` ON `Конвейер`.`Фабрика_Код` = `Фабрика`.`Код`
	LEFT JOIN `Состав конвейера` ON `Состав конвейера`.`Конвейер_Код` = `Конвейер`.`Код`
	LEFT JOIN `Приводной блок` ON `Состав конвейера`.`Приводной блок_Код` = `Приводной блок`.`Код`
	LEFT JOIN `Бункер` ON `Состав конвейера`.`Бункер_Код` = `Бункер`.`Код`
	LEFT JOIN `Став линейный` ON `Состав конвейера`.`Став линейный_Код` = `Став линейный`.`Код`
	LEFT JOIN `Телега разгрузочная` ON `Состав конвейера`.`Телега разгрузочная_Код` = `Телега разгрузочная`.`Код`
	LEFT JOIN `Устройство натяжное` ON `Состав конвейера`.`Устройство натяжное_Код` = `Устройство натяжное`.`Код`
	WHERE `Фабрика`.`Обозначение` = 'ЛФКЛ';

SELECT `Фабрика`.`Наименование`, COUNT(`Конвейер`.`Код`) AS `Число конвейеров`
	FROM `Фабрика`
	INNER JOIN `Конвейер` ON `Конвейер`.`Фабрика_Код` = `Фабрика`.`Код`
	GROUP BY `Фабрика`.`Код`;


SELECT `Фабрика`.`Наименование`, `Двигатель`.`Обозначение`, COUNT(`Двигатель`.`Код`) AS `Количество таких двигателей на фабрике`
	FROM `Фабрика`
	INNER JOIN `Конвейер` ON `Конвейер`.`Фабрика_Код` = `Фабрика`.`Код`
	LEFT JOIN `Состав конвейера` ON `Состав конвейера`.`Конвейер_Код` = `Конвейер`.`Код`
	LEFT JOIN `Приводной блок` ON `Состав конвейера`.`Приводной блок_Код` = `Приводной блок`.`Код`
	LEFT JOIN `Двигатель` ON `Приводной блок`.`Двигатель_Код` = `Двигатель`.`Код`
	WHERE `Фабрика`.`Обозначение` = 'РФКЛ'
	GROUP BY `Фабрика`.`Код`, `Двигатель`.`Код`;

DROP VIEW IF EXISTS `Номенклатура`;
CREATE VIEW `Номенклатура` AS 
SELECT 
	`Фабрика`.`Наименование` AS `Фабрика_Наименование`, 
	`Фабрика`.`Обозначение` AS `Фабрика_Обозначение`, 
	`Конвейер`.`№ конвейера` AS `№ конвейера`, 
	`Конвейер`.`Ширина`, 
	`Конвейер`.`Мощность`, 
	`Конвейер`.`Скорость` AS `Номинальная Скорость`, 
	`Реальная скорость конвейера`(`Конвейер`.`Код`) AS `Реальная Скорость`,
	`Полная масса конвейера`(`Конвейер`.`Код`) AS `Полная масса`,
	`Конвейер`.`Производительность`, 
	`Двигатель`.`Обозначение` AS `Двигатель_Обозначение`, 
	`Барабан приводной`.`Обозначение` AS `Барабан приводной_Обозначение`
	FROM `Фабрика`
	INNER JOIN `Конвейер` ON `Конвейер`.`Фабрика_Код` = `Фабрика`.`Код`
	LEFT JOIN `Состав конвейера` ON `Состав конвейера`.`Конвейер_Код` = `Конвейер`.`Код`
	LEFT JOIN `Приводной блок` ON `Состав конвейера`.`Приводной блок_Код` = `Приводной блок`.`Код`
	LEFT JOIN `Двигатель` ON `Приводной блок`.`Двигатель_Код` = `Двигатель`.`Код`
	LEFT JOIN `Редуктор` ON `Приводной блок`.`Редуктор_Код` = `Редуктор`.`Код`
	LEFT JOIN `Бункер` ON `Состав конвейера`.`Бункер_Код` = `Бункер`.`Код`
	LEFT JOIN `Барабан приводной` ON `Бункер`.`Барабан приводной_Код` = `Барабан приводной`.`Код`;
	
	
SELECT * FROM `Номенклатура` WHERE `Фабрика_Обозначение` = 'ЛФКЛ';



DROP VIEW IF EXISTS `Использование телеги разгрузочной`;
CREATE VIEW `Использование телеги разгрузочной` AS 
SELECT 
	`Телега разгрузочная`.`Обозначение` AS `Телега разгрузочная_Обозначение`, 
	`Фабрика`.`Наименование` AS `Фабрика_Наименование`, 
	`Фабрика`.`Обозначение` AS `Фабрика_Обозначение`, 
	`Конвейер`.`№ конвейера` AS `№ конвейера`
	FROM `Телега разгрузочная` 
	LEFT JOIN `Состав конвейера` ON `Состав конвейера`.`Телега разгрузочная_Код` = `Телега разгрузочная`.`Код`
	INNER JOIN `Конвейер` ON `Состав конвейера`.`Конвейер_Код` = `Конвейер`.`Код`
	INNER JOIN `Фабрика` ON `Конвейер`.`Фабрика_Код` = `Фабрика`.`Код`;

SELECT * FROM `Использование телеги разгрузочной` ORDER BY `Телега разгрузочная_Обозначение`;



DROP VIEW IF EXISTS `Использование барабана приводного`;
CREATE VIEW `Использование барабана приводного` AS 
SELECT 
	`Барабан приводной`.`Обозначение` AS `Барабан приводной_Обозначение`, 
	`Бункер`.`Обозначение` AS `Бункер_Обозначение`, 
	`Фабрика`.`Наименование` AS `Фабрика_Наименование`, 
	`Фабрика`.`Обозначение` AS `Фабрика_Обозначение`, 
	`Конвейер`.`№ конвейера` AS `№ конвейера`
	FROM `Барабан приводной` 
	LEFT JOIN `Бункер` ON `Бункер`.`Барабан приводной_Код` = `Барабан приводной`.`Код`
	LEFT  JOIN `Состав конвейера` ON `Состав конвейера`.`Бункер_Код` = `Бункер`.`Код`
	INNER JOIN `Конвейер` ON `Состав конвейера`.`Конвейер_Код` = `Конвейер`.`Код`
	INNER JOIN `Фабрика` ON `Конвейер`.`Фабрика_Код` = `Фабрика`.`Код`;

SELECT * FROM `Использование барабана приводного` ORDER BY `Барабан приводной_Обозначение`;

